<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <title>Sample Tool</title>
  <script type="text/javascript" charset="utf-8" src="lodash.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="jquery-3.1.0.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="sammy-latest.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="sammy.json.js"></script>
  <script type="text/javascript" charset="utf-8" src="sammy.mustache.js"></script>
  <script type="text/javascript" charset="utf-8" src="raphael-min.js"></script>
  <script type="text/javascript" charset="utf-8" src="jquery.raphael.canvassify.js"></script>
  <script type="text/javascript" charset="utf-8">

    var stroke2path = function(stroke) {
      var first = _.head(stroke);
      var path = _.map(_.tail(stroke), function(point) { return ["L", point[0], point[1]]; })
      if (path.length == 0)
        return [["M", first[0], first[1]], ["l", 0, 0.1]];
      else
        return [["M", first[0], first[1]]].concat(path);
    }

    var app = $.sammy(function() {
      this.use(Sammy.Mustache, 'ms');
      this.use(Sammy.JSON);

      this.get('#/', function() {
        var c = this;
        $.getJSON('/symbols', function(symbols) {
          console.log(symbols);
          symbols = _.sortBy(symbols, function(s) { return s.sample_count })
          var template = '<ul id="symbols">{{#symbols}}<li><a href="#/samples/{{id}}">{{id}}</a> - {{sample_count}} - <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="{{css_class}}"></li>{{/symbols}}</ul>'
          $('#main').html(c.ms(template, {symbols: symbols}));
        });
      });

      this.get('#/samples/:symid', function() {
        var c = this;
        // get samples and display them
        var symid = this.params['symid'];
        $('#main').text('');

        $('#main').append('<div id="training"><div id="tafel"></div><button id="train">train</button><button id="clear">clear</button></div>');
        $('#tafel').canvassify({width:400, height:400})
        $('#train').on('click', function(evt) {
          var canvas = $('#tafel').get(0).canvassified;
          console.log(canvas.strokes);
          $.ajax({
            url: '/samples/'+symid,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({strokes: canvas.strokes}),
            success: function(result) {
              canvas.clear();
            }
          });
        });
        $('#clear').on('click', function(evt) {
          var canvas = $('#tafel').get(0).canvassified;
          canvas.clear();
        });

        $('#main').append('<ul id="samples"></ul>');
        $.getJSON('/symbols', function(symbols) {
          symbol = _.mapValues(_.groupBy(symbols, 'id'), _.head)[symid]
          $('#main').prepend('<div class="symbol"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="'+symbol.css_class+'"></div>');
        });
        $.getJSON('/samples/'+encodeURIComponent(symid), function(samples) {
          console.log(samples);
          samples = _.sortBy(samples, function(s) { return -s.strokes.length*1000-_.sum(_.map(s.strokes, 'length'))-s.strokes[0][0][0]/400; });
          $.each(samples, function(index, sam) {
            var template = '<li class="sample"><div id="sample{{id}}"><span class="sample-stats">'+sam.strokes.length+'/'+_.sum(_.map(sam.strokes, 'length'))+'</span><a href="#" class="delete">X</a></div></li>';
            $('#samples').append(c.ms(template, sam));
            $('#sample'+sam.id+' a').click(function(evt){
              evt.preventDefault();
              console.log('delete '+sam.id);
              $('#sample'+sam.id).closest('li').addClass('deleting');
              $.ajax({
                url: '/samples/'+sam.id,
                type: 'DELETE',
                success: function(result) {
                  $('#sample'+sam.id).closest('li').addClass('deleted');
                }
              });
              return false;
            });
            // draw doc now
            var paper = Raphael('sample'+sam.id, "100%", "100%");
            paper.setViewBox(0, 0, 400, 400);
            $.each(sam.strokes, function(i, stroke) {
              paper.path(stroke2path(stroke)).attr({'stroke-width': 5, 'stroke-linecap': 'round'});
            });
          });
          $('#main').prepend('<a href="#/">back</a>');
        });
      });

      this.del('#/:samid', function() {
        var samid = this.params['samid'];
        return false;
      });

    });

    $(function() {
      app.run('#/');
    });
  </script>
  <style type="text/css" media="screen">
    body, p {
      font-family: sans-serif;
    }

    #tafel {
      border: 1px solid black;
      width: 400px;
      height: 400px;
    }

    ul#symbols {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
    }

    ul#symbols li {
      flex-grow: 1;
      flex-basis: 33%;
      list-style: none;
      padding: 5px;
      box-sizing: border-box;
    }

    ul#symbols li img {
      vertical-align: middle;
    }

    ul#samples li.sample {
      position: relative;
      z-index: 0;
      display: inline;
      float: left;
      width: 200px;
      height: 200px;
      border: 1px solid #eee;
      margin: 2px;
    }

    .sample .sample-stats {
      position: absolute;
      bottom: 0;
      right: 0;
    }

    ul#samples a.delete {
      position: absolute;
      top: 0;
      right: 0;
    }

    ul#samples li.deleting {
      border: 1px solid red;
    }
    ul#samples li.deleted {
      border: 1px solid green;
      display: none;
    }
    .symbol {
      position: fixed;
      left: 50%;
      z-index: 100;
      background: white;
    }
    .symbol img {
      display: block;
      border: none;
      max-width: 60px;
      max-height: 40px;
      margin: auto;
      background: white;
    }
    a.delete {
      font-size: 3em;
      font-weight: bold;
    }
  </style>
  <link rel="stylesheet" href="symbols.css">
  </head>
  <body>
    <div id="container">
      <div id="main">
      </div>
    </div>
  </body>
  </html>
